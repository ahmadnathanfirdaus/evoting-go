{{template "admin_base.html" .}}

{{define "title"}}Manage Tokens - {{.Election.Title}}{{end}}

{{define "breadcrumb"}}
<li class="breadcrumb-item"><a href="/admin/admin/dashboard">Dashboard</a></li>
<li class="breadcrumb-item"><a href="/admin/admin/elections">Elections</a></li>
<li class="breadcrumb-item active">{{.Election.Title}}</li>
<li class="breadcrumb-item active">Tokens</li>
{{end}}

{{define "content"}}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-ticket-alt me-2"></i>Manage Voting Tokens</h2>
        <p class="text-muted mb-0">{{.Election.Title}}</p>
    </div>
    <a href="/admin/admin/elections/{{.Election.ID}}/candidates" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Election
    </a>
</div>

<!-- Generate Tokens Form -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Generate New Tokens</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="/admin/admin/elections/{{.Election.ID}}/tokens/generate" class="row g-3">
            <div class="col-md-6">
                <label for="count" class="form-label">Number of Tokens</label>
                <input type="number" class="form-control" id="count" name="count" min="1" max="1000" value="10" required>
                <div class="form-text">Maximum 1000 tokens per batch</div>
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button type="submit" class="btn btn-success" onclick="return confirm('Generate new voting tokens?')">
                    <i class="fas fa-plus me-2"></i>Generate Tokens
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Tokens List -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Voting Tokens</h5>
        <div>
            <span class="badge bg-primary">Total: {{len .Tokens}}</span>
            <span class="badge bg-success">Used: {{range .Tokens}}{{if .IsUsed}}1{{else}}0{{end}}{{end}}</span>
        </div>
    </div>
    <div class="card-body">
        {{if .Tokens}}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Token</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Used At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Tokens}}
                    <tr>
                        <td>
                            <code class="token-code">{{.Token}}</code>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToken('{{.Token}}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </td>
                        <td>
                            {{if .IsUsed}}
                            <span class="badge bg-success">Used</span>
                            {{else}}
                            <span class="badge bg-warning">Unused</span>
                            {{end}}
                        </td>
                        <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
                        <td>
                            {{if .UsedAt}}
                            {{.UsedAt.Format "2006-01-02 15:04"}}
                            {{else}}
                            <span class="text-muted">-</span>
                            {{end}}
                        </td>
                        <td>
                            {{if not .IsUsed}}
                            <a href="/vote?token={{.Token}}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="fas fa-external-link-alt"></i> Test
                            </a>
                            {{else}}
                            <span class="text-muted">-</span>
                            {{end}}
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{else}}
        <div class="text-center py-4">
            <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Tokens Generated</h5>
            <p class="text-muted">Generate voting tokens to allow people to vote in this election.</p>
        </div>
        {{end}}
    </div>
</div>

<script>
function copyToken(token) {
    navigator.clipboard.writeText(token).then(function() {
        // Show success message
        const button = event.target.closest('button');
        const originalIcon = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check text-success"></i>';
        setTimeout(() => {
            button.innerHTML = originalIcon;
        }, 2000);
    });
}

// Auto-select token text when clicked
document.querySelectorAll('.token-code').forEach(code => {
    code.addEventListener('click', function() {
        const range = document.createRange();
        range.selectNode(this);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
    });
});
</script>
{{end}}
